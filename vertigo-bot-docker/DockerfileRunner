################
# Rasa as base #
################
FROM rasa/rasa:1.2.3

###########
# apt-get #
###########
RUN apt-get update
RUN apt-get install -y rabbitmq-server
RUN mkdir -p /usr/share/man/man1 \
 && apt-get install -y default-jre-headless


################
# Add RabbitMq #
################
RUN mkdir -p /opt/data/rabbitmq/ \
 && chown rabbitmq. /opt/data/rabbitmq \
 && printf '\n\nNODENAME=rabbit-rasa@localhost\nMNESIA_BASE=/opt/data/rabbitmq\n' >> /etc/rabbitmq/rabbitmq-env.conf

 
##############
# Add Tomcat #
##############
ADD apache-tomcat-8.5.50.tar.gz /opt/tomcat/
ADD Runner/vertigo-bot-executor-*.war /opt/tomcat/webapps/ROOT.war

# user home is used for berkeley database
RUN useradd -m tomcat \ 
 && chown -R tomcat. /opt/tomcat \
 && mkdir /opt/data/berkeley \
 && chown tomcat. /opt/data/berkeley

# War configuration through env variables
ENV designerUrl http://host.docker.internal:8080/vertigo-bot-designer
ENV rasaPath /usr/local/bin/rasa
ENV botPath /opt/data/bot/
ENV berkeleyDataPath /opt/data/berkeley/
ENV apiKey MyNodeApiKey!

# Expose tomcat port
EXPOSE 8080

##########################################################
# Add rasa working directory with rabbitmq configuration #
##########################################################
ADD Runner/bot /opt/data/bot/

RUN chown -R tomcat. /opt/data/bot
 
#######################
# start configuration #
#######################
ADD Runner/start.sh /
RUN chmod +x /start.sh

ENTRYPOINT [] # clear entrypoint from base image
CMD ["/start.sh"] # override CMD from base image