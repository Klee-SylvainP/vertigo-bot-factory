<!DOCTYPE html>
<html
	xmlns:th="http://www.thymeleaf.org" 
	xmlns:vu="http://www.morphbit.com/thymeleaf/component"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{templates/botDetailLayout}" th:with="nav=true, tab=models"
	>
	
	<head>
		<title>Models</title>
		
		<script th:inline="javascript">
			var interval;
			VUiExtensions.dataX.loadingRunner = false;
			VUiExtensions.dataX.loadingModels = false;
			VUiExtensions.dataX.loadingTraining = false;
			
			
			function postTrain() {
				interval = setInterval(function() {
					refreshTraining();
				}, 1000);
				
				refreshModels();
			}
			
			function refreshTraining() {
				VUiExtensions.dataX.loadingTraining = true;
				
				VUiPage.httpPostAjax([[@{_refreshTrainer}]], {}, function() {
					VUiExtensions.dataX.loadingTraining = false;
					
					if (vueData.autoscroll) {
						scrollLogToBottom();
					}
					if (!vueData.trainerState.trainingInProgress && interval != null) {
						clearInterval(interval);
						interval = null;
						refreshModels();
					}
				});
			}
			
			function refreshModels() {
				VUiExtensions.dataX.loadingModels = true;
				
				VUiPage.httpPostAjax([[@{_refreshModels}]], {}, function() {
					VUiExtensions.dataX.loadingModels = false;
				});
			}
			
			function refreshRunner() {
				VUiExtensions.dataX.loadingRunner = true;
				
				VUiPage.httpPostAjax([[@{_refreshRunner}]], {}, function() {
					VUiExtensions.dataX.loadingRunner = false;
				});
			}
			
			function scrollLogToBottom() {
				// wait for vue to update dom before scrolling
				Vue.nextTick(function() {
					var obj = document.getElementById("log");
					obj.scrollTop = obj.scrollHeight;
				});
			}
		</script>
	</head>
	
	<body>
		<section layout:fragment="content-nav">
			<q-item tag="a" href="#run">Node state</q-item>
			<q-item tag="a" href="#load">Manage models</q-item>
			<q-item tag="a" href="#train">Training</q-item>
		</section>
		
		<section layout:fragment="content">
			
			<vu:block id="run" title="Node state">
				<vu:slot name="actions_slot">
					<q-btn class="fab-block" round color="primary" icon="refresh" aria-label="Refresh" title="Refresh" 
					       @click="refreshRunner" :loading="dataX.loadingRunner"></q-btn>
				</vu:slot>
				
				<vu:text-field-read-reactive object="runnerState" field="name" />
				<vu:text-field-read-reactive object="runnerState" field="state" />
				<vu:text-field-read-reactive object="runnerState" field="agentVersion" />
				<vu:text-field-read-reactive object="runnerState" field="loadedModelVersion" />
			</vu:block>
			
			<vu:table id="load" list="trainingList" title="Manage models" componentId="trainingList" rowsPerPage="10" autoColClass >
				<vu:slot name="top_right_slot">
					<q-btn class="fab-block" round color="primary" icon="refresh" aria-label="Refresh" title="Refresh" 
					       @click="refreshModels" :loading="dataX.loadingModels"></q-btn>
				</vu:slot>
				<vu:slot name="actions_slot">
					<q-btn class="on-right" round color="primary" icon="cloud_upload" aria-label="Load model"
							 v-if="props.row.status == 'OK'"
							 th:@click="|console.log('click load')|"></q-btn>
					<q-btn class="on-right" round color="red" icon="delete" aria-label="Delete model"
							 v-if="props.row.status != 'TRAINING'"
							 th:@click="|console.log('click del')|"></q-btn>
				</vu:slot>
				
				<vu:include-data object="trainingList" field="traId" />
				
				<vu:column field="status" class="col_Status">
					<q-icon name="check" color="green" size="2rem" v-if="props.row.status == 'OK'"></q-icon>
					<q-icon name="block" color="red" size="2rem" v-if="props.row.status == 'KO'"></q-icon>
					<q-spinner-gears color="orange" class="q-pa-xs" size="2rem" v-if="props.row.status == 'TRAINING'"></q-spinner-gears>
				</vu:column>
				<vu:column field="versionNumber" class="col_Version"/>
				<vu:column field="startTime" />
				<vu:column field="endTime" />
				<vu:column field="tag" />
			</vu:table>
			
			<vu:block id="train" title="Training">
				<vu:slot name="actions_slot">
					<q-btn class="fab-block" round color="primary" icon="refresh" aria-label="Refresh" title="Refresh" 
					       @click="refreshTraining" :loading="dataX.loadingTraining"></q-btn>
				</vu:slot>
				
				<vu:include-data object="trainerState" field="trainingInProgress" />
				<vu:include-data object="trainerState" field="latestTrainingLog" />
				<vu:include-data object="trainerState" field="startTime" />
				<vu:include-data object="trainerState" field="duration" />
				
				<vu:text-field object="trainerState" field="name" />
				
				<vu:label object="trainerState" field="trainingInProgress" label="State">
					<span>{{(vueData.trainerState.trainingInProgress ? 'Training in progress' : 'Ready')}}</span>
				</vu:label>
				
				<q-card-actions>
					<q-btn color="primary" icon="build" size="lg" label="Train" :loading="vueData.trainerState.trainingInProgress"
							th:@click="|httpPostAjax('@{_train}', {}, postTrain)|" style="width: 175px">
						<span slot="loading">
							<q-spinner-gears class="on-left"></q-spinner-gears>
							Training...
						</span>
					</q-btn>
					
					<q-btn color="red" icon="warning" size="lg" label="Stop training" v-if="vueData.trainerState.trainingInProgress"
							th:@click="|httpPostAjax('@{_stop}', {}, refreshModels)|"></q-btn>
				</q-card-actions>
				
				<q-card-separator></q-card-separator>
				
				<q-list bordered class="rounded-borders">
					<q-expansion-item label="Details" icon="details">
						<q-card>
	          				<q-card-section>
								<vu:label object="trainerState" field="startTime">
									<span>{{vueData.trainerState.startTime}}</span>
								</vu:label>
								
								<vu:label object="trainerState" field="duration">
									<span>{{vueData.trainerState.duration}}</span>
								</vu:label>
							
								<vu:label object="trainerState" field="latestTrainingLog">
									<vu:include-data-primitive key="autoscroll" />
									<div class="col">
										<q-toggle label="Auto scroll logs" v-model="vueData.autoscroll" ></q-toggle>
										
										<pre id="log" style="max-height:300px; overflow:auto">{{vueData.trainerState.latestTrainingLog}}</pre>
									</div>
								</vu:label>
							</q-card-section>
						</q-card>
					</q-expansion-item>
				</q-list>
			</vu:block>
			
		</section>
		
		<section layout:fragment="javascript-footer">
			<script>
				if (vueData.trainerState.trainingInProgress) {
					postTrain();
				}
				setTimeout(scrollLogToBottom, 0);
			</script>
		</section>
	</body>
</html>